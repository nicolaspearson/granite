# Granite

This is a monorepo for granite, an online consent management platform.

## Tech Stack

This repository uses:

- [`docker`](https://www.docker.com)
- [`expressjs`](https://expressjs.com)
- [`nestjs`](https://nestjs.com)
- [`typescript`](https://www.typescriptlang.org)
- [`yarn2`](https://yarnpkg.com)

## Getting Started

1. Clone the repo: `git clone git@github.com:nicolaspearson/granite.git`
2. Install [Yarn2](https://yarnpkg.com/getting-started/install)
3. Switch to the latest stable version: `yarn set version stable`
4. Install dependencies: `yarn install`

Optionally install [yamllint](https://yamllint.readthedocs.io/)

### Configure Visual Studio Code

1. Download and install [Visual Studio Code](https://code.visualstudio.com)
2. Open the project
3. Install the extensions listed in `.vscode/extensions.json`
4. Switch to the `granite` workspace by opening `.vscode/granite.code-workspace`, and clicking on
   the "Open Workspace" button.

### Building, Running, and Testing Packages

#### `svc-consents`

The preference / consent management service.

```bash
# Build the package
yarn workspace svc-consents build

# Lint the package
yarn workspace svc-consents lint

# Execute the unit tests for the package
yarn workspace svc-consents test:unit

# Execute the integration tests for the package
yarn workspace svc-consents test:integration
```

## Project Overview

### Configuration Files

- `.dockerignore`: ignores the listed files and directories when using the docker COPY command.
- `.eslintignore`: ignores the listed files and directories when running ESLint.
- `.eslintrc.js`: defines the global ESLint configuration.
- `.pnp.cjs`: automatically generated by Yarn2.
- `.prettierignore`: ignores the listed files and directories when running Prettier.
- `.prettierrc`: defines the global Prettier configuration.
- `.yarnrc.yaml`: yarn2 configuration.
  - [fix dependencies with package extensions](https://yarnpkg.com/getting-started/migration#fix-dependencies-with-packageextensions)
- `docker-compose.yaml`: defines docker image for local testing
- `jest.config.js`: defines the global Jest configuration which is inherited by each package.
- `tsconfig.json`: defines the global TypeScript configuration which is inherited by each package.

### Development Tools

- **commitlint**: to enforce the [conventional commit](https://www.conventionalcommits.org/) style.
- **husky**: commit hooks that run commitlint, yarn and prettier to ensure quality before pushing.
- **eslint**: JavaScript and TypeScript linter.
- **prettier**: code auto formatter.

### Yarn2

This monorepo takes advantage of new Yarn 2 features, e.g. Plug 'n Play and zero-installs,
to prevent traditional problems caused by such setups.

Project configuration:

- Common `devDependencies` to **all** packages are defined as `dependencies`
  in the root `package.json`.
- Common scripts are defined in the root `package.json`, all packages can inherit them.
- Each package has its own specific `scripts`, `dependencies` and `devDependencies`.
- There is no `node_modules` directory, dependencies are committed to the repo via `.yarn/cache`.
  This greatly speeds up CI builds when the monorepo starts to grow.

### Dependency Constraints

The latest version of NestJS (v 8.2.3) does not work with Typescript (v 4.5.2) in Yarn 2 Plug 'n
Play mode. It fails to correctly resolve `@nestjs/...` dependencies.
